name: Architect Start

on:
  issue_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write
  issues: read

jobs:
  architect:
    runs-on: ubuntu-latest
    steps:
      - name: Detect PM handoff
        uses: actions/github-script@v7
        with:
          script: |
            const comment = context.payload.comment;
            const issue = context.payload.issue;

            if (!comment || !issue) return;

            // Only react to PM plan comment
            if (!comment.body.includes("PM agent has started processing")) {
              core.info("Not a PM kickoff comment");
              return;
            }

            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issueNumber = issue.number;

            const branch = `arch/run-${issueNumber}`;

            // Create branch from main
            const { data: main } = await github.rest.repos.getBranch({
              owner,
              repo,
              branch: "main"
            });

            await github.rest.git.createRef({
              owner,
              repo,
              ref: `refs/heads/${branch}`,
              sha: main.commit.sha
            });

            // Create empty commit so PR has content
            const { data: blob } = await github.rest.git.createBlob({
              owner,
              repo,
              content: `Architecture placeholder for run #${issueNumber}\n`,
              encoding: "utf-8"
            });

            const { data: tree } = await github.rest.git.createTree({
              owner,
              repo,
              tree: [
                {
                  path: `docs/architecture/run-${issueNumber}.md`,
                  mode: "100644",
                  type: "blob",
                  sha: blob.sha
                }
              ],
              base_tree: main.commit.commit.tree.sha
            });

            const { data: commit } = await github.rest.git.createCommit({
              owner,
              repo,
              message: `arch: initial architecture for run #${issueNumber}`,
              tree: tree.sha,
              parents: [main.commit.sha]
            });

            await github.rest.git.updateRef({
              owner,
              repo,
              ref: `heads/${branch}`,
              sha: commit.sha
            });

            // Open PR
            const { data: pr } = await github.rest.pulls.create({
              owner,
              repo,
              title: `arch: define architecture for run #${issueNumber}`,
              head: branch,
              base: "main",
              body: `Refs #${issueNumber}`
            });

            // Apply architect handoff label
            await github.rest.issues.addLabels({
              owner,
              repo,
              issue_number: pr.number,
              labels: ["handoff:architect"]
            });
